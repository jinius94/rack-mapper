<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¦ Rack Mapper</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    input { font-size: 20px; width: 300px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #aaa; padding: 5px 10px; text-align: center; }
    .status { margin: 10px 0; font-weight: bold; font-size: 18px; }
    button { font-size: 16px; margin-right: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ ë™ ë°”ì½”ë“œ ë§¤í•‘</h2>

  <div class="status" id="status">From Cellì„ ìŠ¤ìº”í•˜ì„¸ìš”</div>
  <input type="text" id="scanner" autofocus placeholder="ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”">
  <button onclick="cancel()">âŒ ì·¨ì†Œ</button>
  <button onclick="download()">ğŸ’¾ CSV ì €ì¥</button>

  <table id="resultTable">
    <tr><th>From Cell</th><th>To Cell</th><th>ì‚­ì œ</th><th>ìƒíƒœ</th></tr>
  </table>

  <script>
    let expecting = 'from';
    let currentFrom = '';
    const pairs = [];

    const input = document.getElementById('scanner');
    input.focus();

    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        const code = input.value.trim();
        input.value = '';
        if (!code) return;

        if (expecting === 'from') {
          currentFrom = code;
          expecting = 'to';
          document.getElementById('status').innerText = `To Cellì„ ìŠ¤ìº”í•˜ì„¸ìš” (From: ${currentFrom})`;
        } else {
          const to = code;
          const id = Date.now().toString();
          const status = 'â³ ì „ì†¡ ì¤‘...';
          pairs.push([currentFrom, to, id, status]);
          renderTable();
          sendToGoogleSheets(currentFrom, to, id, pairs.length - 1);
          expecting = 'from';
          currentFrom = '';
          document.getElementById('status').innerText = 'From Cellì„ ìŠ¤ìº”í•˜ì„¸ìš”';
        }
      }
    });

    function renderTable() {
      const table = document.getElementById('resultTable');
      table.innerHTML = '<tr><th>From Cell</th><th>To Cell</th><th>ì‚­ì œ</th><th>ìƒíƒœ</th></tr>';
      pairs.forEach(([from, to, id, status], index) => {
        const row = table.insertRow();
        row.insertCell().innerText = from;
        row.insertCell().innerText = to;

        const delBtn = document.createElement('button');
        delBtn.innerText = 'âŒ';
        delBtn.onclick = () => {
          deleteFromGoogleSheets(id, index);
        };
        row.insertCell().appendChild(delBtn);

        const statusCell = row.insertCell();
        statusCell.innerText = status;
        statusCell.id = `status-${index}`;
      });
    }

    function cancel() {
      currentFrom = '';
      expecting = 'from';
      document.getElementById('status').innerText = 'From Cellì„ ë‹¤ì‹œ ìŠ¤ìº”í•˜ì„¸ìš”';
      input.focus();
    }

    function download() {
      let csv = "From Cell,To Cell\n";
      for (let [f, t] of pairs) {
        csv += `"${f}","${t}"\n`;
      }

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `RackMapping_${new Date().toISOString().slice(0,19).replace(/[-:T]/g, '')}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function sendToGoogleSheets(from, to, id, index) {
      fetch('https://script.google.com/macros/s/AKfycbzuz0BpRM0U2cYK1SGlbR54DSIuUJkU4XpaMQwU2OyUGpshzZD5EyDDw4r0qURLbe1qYg/exec', {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ action: "add", id: id, from: from, to: to })
      })
      .then(res => res.text())
      .then(response => {
        document.getElementById(`status-${index}`).innerText = 'âœ… ì „ì†¡ë¨';
      })
      .catch(err => {
        document.getElementById(`status-${index}`).innerText = 'âŒ ì‹¤íŒ¨';
      });
    }

    function deleteFromGoogleSheets(id, index) {
      fetch('https://script.google.com/macros/s/AKfycbzuz0BpRM0U2cYK1SGlbR54DSIuUJkU4XpaMQwU2OyUGpshzZD5EyDDw4r0qURLbe1qYg/exec', {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ action: "delete", id: id })
      })
      .then(res => res.text())
      .then(response => {
        pairs.splice(index, 1);
        renderTable();
      })
      .catch(err => {
        document.getElementById(`status-${index}`).innerText = 'âŒ ì‚­ì œ ì‹¤íŒ¨';
      });
    }
  </script>
</body>
</html>
